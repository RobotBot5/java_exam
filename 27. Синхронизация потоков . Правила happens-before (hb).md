В Java концепция "happens-before" (соответствует "происходит-до") определяет отношение порядка выполнения операций в многопоточных программах. Правила "happens-before" устанавливают, когда одна операция должна быть видима другой операции в контексте многопоточности. Это важно для обеспечения корректного взаимодействия между потоками и избежания ошибок, таких как гонка данных и неопределенные состояния.

### Основные правила happens-before в Java:

1. **Правило программного порядка:**
   - Это базовое правило гласит, что если в программном коде одна инструкция находится до другой, то первая инструкция "happens-before" второй, если эти инструкции не были переупорядочены компилятором или процессором.

2. **Закрытие блока synchronized:**
   - Когда поток завершает выполнение в синхронизированном блоке, все изменения, сделанные этим потоком, становятся видимыми другим потокам, которые начинают выполнение в этом же синхронизированном блоке.

3. **Вход в монитор:**
   - Если поток A входит в синхронизированный блок (захватывает монитор), то все изменения, сделанные этим потоком до входа в блок, будут видны другим потокам, которые войдут в тот же самый монитор после потока A.

4. **Завершение потока:**
   - Когда поток A завершает свое выполнение (все инструкции в потоке A выполнены), все изменения, сделанные потоком A, будут видны другим потокам, которые будут использовать результаты выполнения потока A.

5. **Запись и чтение в volatile переменные:**
   - Если поток A выполняет запись в переменную, объявленную с ключевым словом `volatile`, то эта запись "happens-before" любому последующему чтению этой же переменной потоком B. Это гарантирует, что поток B увидит самое последнее значение, записанное потоком A.

6. **Запуск потока:**
   - Когда поток A вызывает метод `start()` для потока B, завершение выполнения метода `start()` "happens-before" любому действию в потоке B, которое следует за вызовом `start()`. Это гарантирует, что поток B будет видеть все начальные настройки, выполненные потоком A до его запуска.

7. **Join():**
   - Когда поток A вызывает `join()` для потока B, завершение выполнения потока A "happens-before" любому действию в потоке B, которое следует за вызовом `join()`. Это гарантирует, что поток A дождется завершения потока B и увидит все изменения, сделанные потоком B, до продолжения своего выполнения.

8. **Операции в потоках:**
   - Все операции в потоке A, которые происходят до его запуска потока B (с использованием метода `start()`), "happens-before" всем операциям в потоке B, которые происходят после его запуска.

### Пример:

```java

public class HappensBeforeExample {

    private static int counter = 0;

    private static volatile boolean flag = false;

    public static void main(String[] args) throws InterruptedException {

        Thread thread1 = new Thread(() -> {

            counter = 1; // Запись в переменную counter

            flag = true; // Запись в volatile переменную flag

        });

        Thread thread2 = new Thread(() -> {

            if (flag) { // Чтение volatile переменной flag

                System.out.println("Counter value: " + counter); // Чтение переменной counter

            }

        });

        thread1.start();

        thread2.start();

        thread1.join();

        thread2.join();

    }

}

```

В этом примере правило happens-before гарантирует, что запись в переменную `counter` и запись в `volatile` переменную `flag` в потоке `thread1` будут видимы в потоке `thread2`, если `flag` установлен в `true`.

### Заключение:

Правила happens-before в Java обеспечивают важные гарантии относительно порядка выполнения операций между потоками, что позволяет разработчикам писать безопасные и предсказуемые многопоточные приложения. Понимание этих правил помогает избежать распространенных проблем в многопоточной среде, таких как гонка данных и состояния гонки.