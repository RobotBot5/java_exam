В Java концепция "happens-before" (соответствует "происходит-до") определяет отношение порядка выполнения операций в многопоточных программах. Правила "happens-before" устанавливают, когда одна операция должна быть видима другой операции в контексте многопоточности. Это важно для обеспечения корректного взаимодействия между потоками и избежания ошибок, таких как гонка данных и неопределенные состояния.

### Основные правила happens-before в Java:

1. **Правило программного порядка:**

   - Каждая инструкция в потоке A происходит до всех инструкций в потоке B, следующих за ней в программном коде, если эти инструкции не переупорядочиваются компилятором или процессором.

2. **Закрытие блока synchronized:**

   - Завершение синхронизированного блока (выход из блока `synchronized`) A происходит до начала входа в синхронизированный блок B для того же монитора.

3. **Вход в монитор:**

   - Запуск потока A входит в синхронизированный блок для монитора M, до того как поток B получит доступ к тому же монитору M.

4. **Завершение потока:**

   - Завершение всех действий в потоке A происходит до запуска действий в потоке B, который был создан из потока A.

5. **Запись и чтение в volatile переменные:**

   - Запись в переменную типа `volatile` A происходит до чтения из этой же переменной B.

6. **Запуск потока:**

   - Запуск потока A завершается до любой операции в потоке B, которая следует за вызовом `Thread.start()` для потока B.

7. **Join():**

   - Завершение потока A, вызванного методом `join()` для потока B, происходит до любого действия в потоке B, которое идет после вызова `join()`.

8. **Операции в потоках:**

   - Все операции в потоке A, которые происходят до запуска потока B, гарантированно происходят до всех операций в потоке B, которые происходят после запуска потока B.

### Пример:

```java

public class HappensBeforeExample {

    private static int counter = 0;

    private static volatile boolean flag = false;

    public static void main(String[] args) throws InterruptedException {

        Thread thread1 = new Thread(() -> {

            counter = 1; // Запись в переменную counter

            flag = true; // Запись в volatile переменную flag

        });

        Thread thread2 = new Thread(() -> {

            if (flag) { // Чтение volatile переменной flag

                System.out.println("Counter value: " + counter); // Чтение переменной counter

            }

        });

        thread1.start();

        thread2.start();

        thread1.join();

        thread2.join();

    }

}

```

В этом примере правило happens-before гарантирует, что запись в переменную `counter` и запись в `volatile` переменную `flag` в потоке `thread1` будут видимы в потоке `thread2`, если `flag` установлен в `true`.

### Заключение:

Правила happens-before в Java обеспечивают важные гарантии относительно порядка выполнения операций между потоками, что позволяет разработчикам писать безопасные и предсказуемые многопоточные приложения. Понимание этих правил помогает избежать распространенных проблем в многопоточной среде, таких как гонка данных и состояния гонки.